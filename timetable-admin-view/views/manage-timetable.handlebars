<div class="card">
    <h2 style="color: #667eea; margin-bottom: 20px;">Create New Timetable Slot</h2>
    
    <div id="alertContainer"></div>
    
    <form id="createSlotForm" action="/timetable/slot/create" method="POST">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
            <div class="form-group">
                <label for="group_id">Group *</label>
                <select name="group_id" id="group_id" required onchange="loadSubjects(this.value)">
                    <option value="">Select Group</option>
                    {{#each groups}}
                        <option value="{{id}}" data-level="{{level_id}}">{{name}}</option>
                    {{/each}}
                </select>
            </div>
            
            <div class="form-group">
                <label for="subject_id">Subject *</label>
                <select name="subject_id" id="subject_id" required>
                    <option value="">Select Group First</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="teacher_id">Teacher *</label>
                <select name="teacher_id" required>
                    <option value="">Select Teacher</option>
                    {{#each teachers}}
                        <option value="{{id}}">{{name}}</option>
                    {{/each}}
                </select>
            </div>
            
            <div class="form-group">
                <label for="room_id">Room *</label>
                <select name="room_id" required>
                    <option value="">Select Room</option>
                    {{#each rooms}}
                        <option value="{{id}}">{{code}} - {{name}}</option>
                    {{/each}}
                </select>
            </div>
            
            <div class="form-group">
                <label for="day_of_week">Day of Week *</label>
                <select name="day_of_week" required>
                    <option value="1">Monday</option>
                    <option value="2">Tuesday</option>
                    <option value="3">Wednesday</option>
                    <option value="4">Thursday</option>
                    <option value="5">Friday</option>
                    <option value="6">Saturday</option>
                    <option value="7">Sunday</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="start_time">Start Time *</label>
                <input type="time" name="start_time" id="start_time" required>
            </div>
            
            <div class="form-group">
                <label for="end_time">End Time *</label>
                <input type="time" name="end_time" id="end_time" required>
            </div>
            
            <div class="form-group">
                <label for="academic_year">Academic Year *</label>
                <input type="text" name="academic_year" placeholder="2024-2025" required>
            </div>
            
            <div class="form-group">
                <label for="semester">Semester *</label>
                <select name="semester" required>
                    <option value="1">Semester 1</option>
                    <option value="2">Semester 2</option>
                </select>
            </div>
        </div>
        
        <button type="submit" class="btn btn-success" style="margin-top: 20px;">
            Create Slot
        </button>
    </form>
</div>

<div class="card">
    <h2 style="color: #667eea; margin-bottom: 20px;">Existing Timetable Slots</h2>
    
    <table>
        <thead>
            <tr>
                <th>Day</th>
                <th>Time</th>
                <th>Subject</th>
                <th>Teacher</th>
                <th>Group</th>
                <th>Room</th>
                <th>Year/Semester</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {{#each slots}}
                <tr>
                    <td>{{getDayName day_of_week}}</td>
                    <td>{{formatTime start_time}} - {{formatTime end_time}}</td>
                    <td>{{subject_name}}</td>
                    <td>{{teacher_name}}</td>
                    <td>{{group_name}}</td>
                    <td>{{room_code}}</td>
                    <td>{{academic_year}} / S{{semester}}</td>
                    <td>
                        <form action="/timetable/slot/delete/{{id}}" method="POST" style="display: inline;" 
                              onsubmit="return confirm('Are you sure you want to delete this slot?');">
                            <button type="submit" class="btn btn-danger" style="padding: 6px 12px; font-size: 0.85rem;">
                                Delete
                            </button>
                        </form>
                    </td>
                </tr>
            {{else}}
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px; color: #999;">
                        No timetable slots found. Create one above!
                    </td>
                </tr>
            {{/each}}
        </tbody>
    </table>
</div>

<script>
function showAlert(message, type = 'error') {
    const alertContainer = document.getElementById('alertContainer');
    const alertDiv = document.createElement('div');
    alertDiv.className = `custom-alert alert-${type}`;
    alertDiv.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: 15px;">
                <div style="width: 4px; height: 40px; background: currentColor; border-radius: 2px;"></div>
                <div>
                    <strong style="display: block; margin-bottom: 5px;">${type === 'error' ? 'Conflict Detected' : 'Success'}</strong>
                    <span>${message}</span>
                </div>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: inherit; padding: 0 10px; opacity: 0.6; line-height: 1;">&times;</button>
        </div>
    `;
    
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        alertDiv.style.opacity = '0';
        setTimeout(() => alertDiv.remove(), 300);
    }, 5000);
    
    // Scroll to alert
    alertDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

document.getElementById('createSlotForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    // Validate time
    const startTime = data.start_time;
    const endTime = data.end_time;
    
    if (startTime >= endTime) {
        showAlert('End time must be after start time!', 'error');
        return;
    }
    
    const submitButton = this.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = 'Creating...';
    
    try {
        const response = await fetch('/timetable/slot/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
            showAlert('Timetable slot created successfully!', 'success');
            setTimeout(() => window.location.reload(), 1500);
        } else {
            showAlert(result.message || result.error || 'An error occurred', 'error');
        }
    } catch (error) {
        showAlert('Failed to create slot. Please try again.', 'error');
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'âž• Create Slot';
    }
});

async function loadSubjects(groupId) {
    const subjectSelect = document.getElementById('subject_id');
    subjectSelect.innerHTML = '<option value="">Loading...</option>';
    
    if (!groupId) {
        subjectSelect.innerHTML = '<option value="">Select Group First</option>';
        return;
    }
    
    try {
        const groupOption = document.querySelector(`#group_id option[value="${groupId}"]`);
        const levelId = groupOption.getAttribute('data-level');
        
        const response = await fetch(`/timetable/api/subjects/${levelId}`);
        const subjects = await response.json();
        
        subjectSelect.innerHTML = '<option value="">Select Subject</option>';
        subjects.forEach(subject => {
            const option = document.createElement('option');
            option.value = subject.id;
            option.textContent = `${subject.code} - ${subject.name}`;
            subjectSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading subjects:', error);
        subjectSelect.innerHTML = '<option value="">Error loading subjects</option>';
    }
}
</script>